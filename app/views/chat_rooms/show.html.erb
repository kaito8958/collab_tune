<div class="chat-room-page">
  <div class="chat-header">
    <% partner = (@chat_room.receiver == current_user ? @chat_room.requester : @chat_room.receiver) %>

    <div class="chat-header-inner">
      <!-- ç›¸æ‰‹ã®ã‚¢ã‚¤ã‚³ãƒ³ -->
      <% if partner.icon.attached? %>
        <%= image_tag partner.icon.variant(resize_to_fill: [40, 40]).processed, class: "chat-partner-icon" %>
      <% else %>
        <%= image_tag "default_icon.png", size: "40x40", class: "chat-partner-icon" %>
      <% end %>

      <div class="chat-header-info">
        <h3><%= partner.nickname %> ã•ã‚“ã¨ã®ãƒãƒ£ãƒƒãƒˆ</h3>
        <% if @chat_room.collaboration.present? %>
          <p class="chat-post-title">æŠ•ç¨¿: <%= @chat_room.collaboration.post.title %></p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="chat-container">
    <div id="messages"
        data-chat-room-id="<%= @chat_room.id %>"
        data-last-message-id="<%= @messages.last&.id || 0 %>">
      <%= render partial: "messages/message", collection: @messages, as: :message, locals: { sender_id: current_user.id } %>
    </div>

    <%= form_with(
          model: [@chat_room, @message],
          html: { id: "message_form", data: { turbo: false } },
          local: false
        ) do |form| %>
      <%= form.text_area :content, rows: 2 %>
      <%= form.submit "é€ä¿¡" %>
    <% end %>


    <!-- ğŸ“ ã‚®ã‚¬ãƒ•ã‚¡ã‚¤ãƒ«ä¾¿æ¡ˆå†… -->
    <p class="gigafile-note">
      å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã™ã‚‹å ´åˆã¯
      <a href="https://gigafile.nu/" target="_blank">ã‚®ã‚¬ãƒ•ã‚¡ã‚¤ãƒ«ä¾¿</a>
      ã®ãƒªãƒ³ã‚¯ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
    </p>
  </div>
</div>

<!-- 
<script type="module">
  import { subscribeToMessages } from "/assets/channels/message_channel.js";
  subscribeToMessages(<%= @chat_room.id %>);
</script>
-->


<script>
  document.addEventListener("turbo:submit-end", (event) => {
    const form = event.target;
    if (form.closest("#message_form")) form.reset();
  });

  document.addEventListener("turbo:load", () => {
    const messagesDiv = document.getElementById("messages");
    if (!messagesDiv) return;
    const scrollToBottom = () => messagesDiv.scrollTop = messagesDiv.scrollHeight;
    scrollToBottom();
    const observer = new MutationObserver(scrollToBottom);
    observer.observe(messagesDiv, { childList: true });
  });
</script>

<script type="module">
  import "chat_ajax"
</script>