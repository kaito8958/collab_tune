<h2><%= @post.title %></h2>

<p><%= @post.description %></p>
<p>ジャンル: <%= @post.genre.presence || "未設定" %></p>
<p>テンポ: <%= @post.tempo.presence || "未設定" %> BPM</p>
<p>投稿者: <%= @post.user.nickname %></p>

<% if @post.audio.attached? %>
  <p>🎵 音源を再生:</p>
  <audio controls>
    <source src="<%= url_for(@post.audio) %>" type="audio/mpeg">
    お使いのブラウザはオーディオ再生をサポートしていません。
  </audio>
<% else %>
  <p>音源ファイルはアップロードされていません。</p>
<% end %>

<hr>

<% if user_signed_in? && current_user == @post.user %>
  <%= link_to "編集", edit_post_path(@post), class: "btn btn-primary" %>
  <%= link_to "削除", @post, data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" }, class: "btn btn-danger" %>
<% end %>

<%= link_to "一覧に戻る", posts_path %>

<hr>

<h3>コメント一覧</h3>
<% if @post.comments.any? %>
  <ul>
    <% @post.comments.each do |comment| %>
      <li>
        <strong><%= comment.user.nickname %>：</strong>
        <%= comment.body %>
        <% if comment.user == current_user %>
          <%= link_to '削除', post_comment_path(@post, comment), method: :delete, data: { confirm: '本当に削除しますか？' } %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>まだコメントはありません。</p>
<% end %>

<hr>

<% if user_signed_in? %>
  <h4>コメントを投稿する</h4>
  <%= form_with(model: [@post, Comment.new], local: true) do |f| %>
    <div class="field">
      <%= f.text_area :body, rows: 3, placeholder: "コメントを入力..." %>
    </div>
    <div class="actions">
      <%= f.submit "送信", class: "btn btn-primary" %>
    </div>
  <% end %>
<% else %>
  <p>コメントを投稿するにはログインが必要です。</p>
<% end %>

<hr>

<% if user_signed_in? && current_user != @post.user %>
  <h3>コラボ申請</h3>
  <%= form_with(model: Collaboration.new, url: collaborations_path, local: true) do |f| %>
    <%= f.hidden_field :receiver_id, value: @post.user.id %>
    <%= f.hidden_field :post_id, value: @post.id %>
    <div>
      <%= f.label :message, "メッセージ" %><br>
      <%= f.text_area :message, rows: 3 %>
    </div>
    <div>
      <%= f.submit "コラボ申請を送る" %>
    </div>
  <% end %>
<% end %>
